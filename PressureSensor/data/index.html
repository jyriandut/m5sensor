<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="color-scheme" content="light">
        
        <link rel="stylesheet" href="pico.lime.min.css">
        <title>M5 Atom: Pressure sensor interface</title>
    </head>
    <body>
        <main class="container" x-data="ledApp()" x-init="init()">
            <header>
                <h1 x-data="{ message: 'Initial Configuration Page' }" x-text="message"></h1>
                <div>
                    <span> Select color of the led:</span>
                    <span> color goes here background </span>
                </div>
            </header>
            <article>
                <header>
                    <h3>Select new color</h3>
                </header>
                <div class="grid">
                    <label>
                        <input type="color" x-model="color" />
                    </label>
                    <button
                        @click="applyColor"
                        :aria-busy="busy"
                        :disabled="busy"
                    >Apply color</button>
                </div>
                <p x-show="err" style="color:#b00020" x-text="err"></p>
                <p x-show="ok" style="color:#1b5e20" x-text="ok"></p>
            </article>
            <hr />
            <article>
                <header>
                    <h3> WiFi Settings (stored to flash)</h3>
                </header>
                <form x-init="fetchWifiSettings()" @submit.prevent="saveWifiSettings">
                    <fieldset :aria-busy="wifiBusy">
                        <label>
                            WiFi SSID:
                            <input
                                x-model="wifiSettings.ssid"
                                type="text"
                                required
                            />
                        </label>
                        <label x-data="{ show: false }">
                            Password:
                            <input :type="show ? 'text' : 'password'" x-model="wifiSettings.pass" required />
                            <button type="button" @click="show = !show" aria-label="Toggle password visibility">
                                <span x-text="show ? 'Hide password' : 'Show password'"></span>
                            </button>
                        </label>
                        
                        <label>
                            Authentication token (will be added later):
                            <textarea
                                x-model="wifiSettings.token"
                                type="textfield"
                                name="token"
                                placeholder=""
                            ></textarea>
                        </label>
                    </fieldset>

                    <input                        
                        :disabled="wifiBusy"
                        type="submit"
                        value="Save"
                    />
                </form>
            </article>
        </main>
        <script src="alpine.min.js" defer></script>
        <script defer>
         function ledApp() {
             return {
                 busy: false,
                 wifiBusy: false,
                 color: '#00ff00',
                 currentColor: '#000000',
                 msg: '',
                 err: '',
                 ok: '',
                 wifiSettings: {
                     ssid: 'abc',
                     pass: 'asdad',
                     token: 'akdk',
                 },

                 async init() {
                     try {
                         const r = await fetch('/api/led');
                         if (r.ok) {
                             const data = await r.json();
                             this.currentColor = data.color || this.currentColor;
                             this.color = data.color || this.color;
                         }                         
                         
                     } catch (_) { /* ignore on first load */ }
                 },
                 async fetchWifiSettings() {
                     try {
                         const wifi = await fetch('/api/wifi');
                         if (wifi.ok) {
                             const data = await wifi.json();
                             this.wifiSettings = {
                                 ssid: data.ssid,
                                 pass: data.pass,
                                 token: data.token
                             };
                             console.log("WIFI Settings ", this.wifiSettings);
                         }
                     } catch (_) {
                     }
                     
                 },
                 async saveWifiSettings() {
                     this.wifiBusy = true;
                     //this.wifiMsg = '';
                     //this.wifiErr = '';

                     try {
                         const r = await fetch('/api/wifi', {
                             method: 'POST',
                             headers: {'Content-Type':'application/json'},
                             body: JSON.stringify({
                                 ssid: this.wifiSettings.ssid,
                                 pass: this.wifiSettings.pass,
                                 token: this.wifiSettings.token
                             }),
                         });
                         if (!r.ok) throw new Error(await r.text());
                         //this.wifiMsg = 'Wifi Settings Upddated';
                     } catch (e) {
                         console.log("ERROR saving wifi")
                         //this.wifiErr = e.message || 'Failed to wifi settings';
                     } finally {
                         this.wifiBusy = false;
                         //this.wifiErr = false;
                     }
                 },
                 async applyColor() {
                     console.log("Applying color");
                     this.busy = true;
                     this.msg = '';
                     this.err = '';

                     try {
                         const r = await fetch('/api/led', {
                             method: 'POST',
                             headers: {'Content-Type':'application/json'},
                             body: JSON.stringify({ color: this.color }) // "#RRGGBB"
                         });
                         if (!r.ok) throw new Error(await r.text());
                         const data = await r.json();
                         this.currentColor = data.color || this.color;
                         this.msg = 'LED updated';
                     } catch (e) {
                         this.err = e.message || 'Failed to update LED';
                     } finally {
                         this.busy = false;
                     }
                 }
             }
         }
        </script>
    </body>
</html>
